{{factory 'module' 'catalog:breadcrumbs'}}

<!--Checkout-->
<section class="checkout">
    <div class="container">

        {{!
        <!--Expandable Panels-->
        <div class="row">
            <div class="col-lg-12">
                <h2>Checkout</h2>
                <!--Hidden Panels-->
                <a class="panel-toggle" href="#login"><i></i>Returning customer? Click here to login</a>
                <div class="row">
                    <div class="hidden-panel" id="login">
                        <div class="col-lg-12">
                            <div class="row">
                                <div class="col-lg-7 col-md-7 col-sm-7">
                                    <form class="login-form" method="post">
                                        <div class="form-group group">
                                            <label for="log-email2">Email</label>
                                            <input type="email" class="form-control" name="log-email2" id="log-email2" placeholder="Enter your email" required>
                                            <a class="help-link" href="#">Forgot email?</a>
                                        </div>
                                        <div class="form-group group">
                                            <label for="log-password2">Password</label>
                                            <input type="text" class="form-control" name="log-password2" id="log-password2" placeholder="Enter your password" required>
                                            <a class="help-link" href="#">Forgot password?</a>
                                        </div>
                                        <div class="checkbox">
                                            <label><input type="checkbox" name="remember"> Remember me</label>
                                        </div>
                                        <input class="btn btn-success" type="submit" value="Login">
                                    </form>
                                </div>
                                <div class="col-lg-5 col-md-5 col-sm-5">
                                    <label>Use social accounts</label>
                                    <div class="social-login">
                                        <a class="facebook" href="#"><i class="fa fa-facebook-square"></i></a>
                                        <a class="google" href="#"><i class="fa fa-google-plus-square"></i></a>
                                        <a class="twitter" href="#"><i class="fa fa-twitter-square"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <a class="panel-toggle" href="#coupon"><i></i>Have a coupon? Click here to enter your code</a>
                <div class="row">
                    <div class="col-lg-5">
                        <div class="hidden-panel" id="coupon">
                            <form name="coupon-code" method="post">
                                <div class="form-group">
                                    <label class="sr-only" for="coupon-code">Enter coupon code</label>
                                    <input type="text" class="form-control" id="coupon-code" name="coupon-code" placeholder="Enter coupon code">
                                </div>
                                <input type="submit" class="btn btn-primary btn-sm btn-block" name="apply-coupon" value="Apply coupon">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }}

        <!--Checkout Form-->
        <div class="row">
            <form id="checkout-form" method="post" action="/checkout">
                {{#if oneclick}}
                    {{#each products}}
                        <input type="hidden" name="oneclick[{{_id}}]" value="{{count}}"/>
                    {{/each}}
                {{/if}}
                <!--Left Column-->
                <div class="col-lg-8 col-md-8 col-sm-8">
                    <h3>Оформление заказа</h3>

                    <div class="row">
                        <div class="form-group col-lg-6 col-md-6 col-sm-6">
                            <label for="contact">Контактные данные</label>
                            <input type="text" class="form-control" id="contact" name="contact" value="{{lastOrder.contact}}" placeholder="Email, телефон или скайп" required autocomplete="off"/>
                        </div>

                        <div class="form-group col-lg-6 col-md-6 col-sm-6 has-feedback has-success hide contact-group">
                            <label for="skype">Skype</label>
                            <input type="text" class="form-control" id="skype" name="skype" readonly autocomplete="off"/>
                            <i class="fa fa-skype form-control-feedback"></i>
                        </div>

                        <div class="form-group col-lg-6 col-md-6 col-sm-6 has-feedback has-success hide contact-group">
                            <label for="email">E-mail</label>
                            <input type="email" class="form-control" id="email" name="email" readonly autocomplete="off"/>
                            <i class="fa fa-envelope form-control-feedback"></i>
                        </div>

                        <div class="form-group col-lg-6 col-md-6 col-sm-6 has-feedback has-success hide contact-group">
                            <label for="phone">Телефон</label>
                            <input type="text" class="form-control" id="phone" name="phone" readonly autocomplete="off"/>
                            <i class="fa fa-phone form-control-feedback"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fullname">Ф.И.О.</label>
                        <input type="text" class="form-control" id="fullname" name="fullname" value="{{lastOrder.fullname}}" placeholder="Получатель посылки" required/>
                    </div>

                    <div class="row fullname-group hide">
                        <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                            <label for="name">Имя</label>
                            <input type="text" class="form-control" id="name" name="name[name]" value="{{lastOrder.name.name}}" placeholder="" readonly/>
                            <i class="fa fa-times form-control-feedback hide"></i>
                            <i class="fa fa-check form-control-feedback hide"></i>
                        </div>
                        <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                            <label for="name">Фамилия</label>
                            <input type="text" class="form-control" id="surname" name="name[surname]" value="{{lastOrder.name.surname}}" placeholder="" readonly/>
                            <i class="fa fa-times form-control-feedback hide"></i>
                            <i class="fa fa-check form-control-feedback hide"></i>
                        </div>
                        <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                            <label for="name">Отчество</label>
                            <input type="text" class="form-control" id="patronymic" name="name[patronymic]" value="{{lastOrder.name.patronymic}}" placeholder="" readonly/>
                            <i class="fa fa-times form-control-feedback hide"></i>
                            <i class="fa fa-check form-control-feedback hide"></i>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="fulladdress">Полный адрес доставки</label>
                        <input type="text" class="form-control" id="fulladdress" value="{{lastOrder.fulladdress}}" name="fulladdress" placeholder="Адрес получателя" required>
                    </div>

                    <div class="fulladdress-group hide">
                        <div class="row">
                            <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                                <label for="postal_code">Индекс</label>
                                <input type="text" class="form-control" id="postal_code" name="address[code]" value="{{lastOrder.address.code}}" placeholder="" readonly/>
                                <i class="fa fa-times form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>

                            <div class="form-group col-lg-8 col-md-8 col-sm-8 has-feedback">
                                <label for="region">Регион</label>
                                <input type="text" class="form-control" id="region" name="address[region]" value="{{lastOrder.address.region}}" placeholder="" readonly/>
                                <i class="fa fa-times form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-lg-6 col-md-6 col-sm-6 has-feedback">
                                <label for="city">Город (нас. пункт)</label>
                                <input type="text" class="form-control" id="city" name="address[city]" value="{{lastOrder.address.city}}" placeholder="" readonly/>
                                <i class="fa fa-times form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>

                            <div class="form-group col-lg-6 col-md-6 col-sm-6 has-feedback">
                                <label for="street">Улица</label>
                                <input type="text" class="form-control" id="street" name="address[street]" value="{{lastOrder.address.street}}" placeholder="" readonly/>
                                <i class="fa fa-times form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                                <label for="house">Дом/строение</label>
                                <input type="text" class="form-control" id="house" name="address[house]" value="{{lastOrder.address.house}}" placeholder="" readonly/>
                                <i class="fa fa-times form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>

                            <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                                <label for="block">Корпус</label>
                                <input type="text" class="form-control" id="block" name="address[block]" value="{{lastOrder.address.block}}" placeholder="" readonly/>
                                <i class="fa fa-exclamation-triangle form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>

                            <div class="form-group col-lg-4 col-md-4 col-sm-4 has-feedback">
                                <label for="flat">Квартира</label>
                                <input type="text" class="form-control" id="flat" name="address[flat]" value="{{lastOrder.address.flat}}" placeholder="" readonly/>
                                <i class="fa fa-exclamation-triangle form-control-feedback hide"></i>
                                <i class="fa fa-check form-control-feedback hide"></i>
                            </div>
                        </div>


                    </div>
                    <h3>Комментарий к заказу</h3>
                    <div class="form-group">
                        <label class="sr-only" for="comment">Комментарий к заказу</label>
                        <textarea class="form-control" name="comment" id="comment" rows="4" placeholder="Оставьте комментарий для менеджера"></textarea>
                    </div>
                </div>

                <!--Right Column-->
                <div class="col-lg-3 col-lg-offset-1 col-md-4 col-sm-4">
                    <h3>Ваш заказ</h3>
                    <table>
                        <tr><th>Товары</th></tr>
                        {{#each products}}
                            <tr>
                                <td class="name border">{{title}}<span>x{{count}}</span></td>
                                <td class="price border">{{number-format total}}&nbsp;<i class="fa fa-rouble"></i></td>
                            </tr>
                        {{/each}}

                        <tr>
                            <td class="th">Итого</td>
                            <td class="price">{{number-format total}} <i class="fa fa-rouble"></i></td>
                        </tr>
                        <tr>
                            <td class="th border">Доставка</td>
                            <td class="align-r border">{{#if delivery}}{{delivery}} <span class="fa fa-rouble"></span>{{else}}Бесплатно{{/if}}</td>
                        </tr>
                        <tr>
                            <td class="th">Общий счет</td>
                            <td class="price">{{number-format orderTotal}} <span class="fa fa-rouble"></span></td>
                        </tr>
                    </table>
                    {{!
                    <div class="payment-method">
                        <div class="radio light">
                            <label><input type="radio" name="payment" id="payment01" checked> Direct Bank Transfer</label>
                        </div>
                        <p>Make your payment directly into our bank account. Please use your Order ID as the payment reference. Your order will not be shipped until the funds have cleared in our account.</p>
                        <div class="radio light">
                            <label><input type="radio" name="payment" id="payment02"> Cheque Payment</label>
                        </div>
                        <div class="radio light">
                            <label><input type="radio" name="payment" id="payment03"> PayPal <span class="pp-label"></span></label>
                        </div>
                    </div>
                    }}
                    <input class="btn btn-success btn-block" type="submit" name="place-order" value="Заказать">
                </div>
            </form>
        </div>
    </div>
</section><!--Checkout Close-->



<script type="text/javascript" src="https://dadata.ru/static/js/jquery.suggestions-4.6.min.js"></script>
<script type="text/javascript">
    var toggleError = function($el,hasError){
        if(typeof hasError == "undefined"){
            hasError = false;
        }

        var errorClass = ($el.attr('id') == 'flat' || $el.attr('id') == 'block') ? 'has-warning' : 'has-error',
                timesClass = ($el.attr('id') == 'flat' || $el.attr('id') == 'block') ? 'fa-exclamation-triangle' : 'fa-times';

        if(hasError){
            $el.closest('.form-group').
                    removeClass('has-success').
                    addClass(errorClass).
                    find('.fa-check').addClass('hide').
                    parent().find('.'+timesClass).removeClass('hide');
        }else{
            $el.closest('.form-group').
                    removeClass(errorClass).
                    addClass('has-success').
                    find('.'+timesClass).addClass('hide').
                    parent().find('.fa-check').removeClass('hide');
        }
    }

    $("#fulladdress").suggestions({
        serviceUrl: "https://dadata.ru/api/v2",
        token: "4e8f740f9a2e275a91e5a904e64729e935b3fad0",
        type: "ADDRESS",
        hint:'Выберите предложенный вариант:',
        deferRequestBy: 300,
        onSelect: function(suggestion) {
            $(".fulladdress-group").find('input').val('');
            var data = suggestion.data,
                    fields = ['postal_code','region','city','street','house','block','flat'],
                    aliases = {
                        city:'settlement'
                    },
                    prefixes = {
                        street:'street_type',
                        settlement:'settlement_type',
                        city:'city_type'
                    },
                    postfixes = {
                        region:'region_type_full'
                    };

            $(fields).each(function(i,field){

                var value = data[field] || data[aliases[field]],
                        naturalField = (!data[field] && data[aliases[field]]) ? aliases[field] : field,
                        prefix = (prefixes[naturalField]) ? (data[prefixes[naturalField]] + '. ') : '',
                        postfix = (postfixes[naturalField]) ? (' ' + data[postfixes[naturalField]]) : '';

                if(!value && field == 'city' && data.region){
                    value =  data.region;
                    prefix = data.region_type + '. ';
                    postfix = '';
                }

                if(value){
                    $('#' + field).val(prefix + value + postfix);
                    toggleError($('#' + field),false);
                }else{
                    toggleError($('#' + field),true);
                }
            });

            if(!$(".fulladdress-group .has-error").size()){
                $("#fulladdress").parent().hide(300);
            }
        },
        onSelectNothing:function(value){
            $("#fulladdress").addClass('error').focus();
        }
    }).keydown(function(){
                if($(".fulladdress-group").is(':hidden')){
                    $(".fulladdress-group").hide().removeClass('hide').show(300);
                }
            });

    $(".fulladdress-group").click(function(){
        if($("#fulladdress").parent().is(':hidden')){
            $("#fulladdress").parent().show(300).find('input').focus();
        }
    });


    $(".fullname-group").click(function(){
        if($("#fullname").parent().is(':hidden')){
            $("#fullname").parent().show(300).find('input').focus();
        }
    });


    $("#fullname").suggestions({
        serviceUrl: "https://dadata.ru/api/v2",
        token: "4e8f740f9a2e275a91e5a904e64729e935b3fad0",
        type: "NAME",
        hint:'Выберите предложенный вариант:',
        deferRequestBy: 300,
        /* Вызывается, когда пользователь выбирает одну из подсказок */
        onSelect: function(suggestion) {
            var data = suggestion.data,
                    fields = ['name','surname','patronymic'];

            $(fields).each(function(i,field){
                if(data[field]){
                    $('#' + field).val(data[field]);
                    toggleError($('#' + field),false);
                }else{
                    toggleError($('#' + field),true);
                }
            });

            if(!$(".fullname-group .has-error").size()){
                $("#fullname").parent().hide(300);
            }
        },
        onSelectNothing:function(value){
            var data = value.split(' '),
                    fields = ['name','surname','patronymic'];

            $(fields).each(function(i,field){
                $('#' + field).val('');
                toggleError($('#' + field),true);
            });

            $(data).each(function(i,value){
                $('#' + fields[i]).val(value);
                toggleError($('#' + fields[i]),false);
            });

            if(!$(".fullname-group .has-error").size()){
                $("#fullname").parent().hide(300);
            }
        }
    }).keydown(function(){
                if($(".fullname-group").is(':hidden')){
                    $(".fullname-group").hide().removeClass('hide').show(300);
                }
            });


    $("#checkout-form").submit(function(){
        if($(this).find('.has-error').size()){
            return false;
        }

        if(!$("#email").val() && !$("#phone").val() && !$("#skype").val()){
            $("#contact").val('').focus();
            return false;
        }
    });


    $("#contact").on('keyup',function(){
        var $this = $(this),
                value = $this.val(),
                emailReg = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
                phoneReg = /^\D?(\d{3})\D?\D?(\d{3})\D?(\d{2})\D?(\d{2})/,
                phonePattern = "($1) $2-$3-$4",
                digits = value.replace(/[А-Яа-яA-Za-z$-]/g, ""),
                skypeReg = /[a-zA-Z][a-zA-Z0-9\.,\-_]{5,31}/,
                runSkype = true;

        $("#email,#skype,#phone").val('');
        $('.contact-group').hide();

        if(value.length >= 5){
            if(emailReg.test(value)){
                $("#email").val(value).closest('.form-group').hide().removeClass('hide').show();
                return;
            }else{
                if(digits.length >= 8){
                    var phone = '';
                    if(digits[0] == 8){
                        phone = '+7 ' + digits.substring(1).replace(phoneReg,phonePattern);
                    }else if(digits[0] == '+' && digits[1] == 7){
                        phone = '+7 ' + digits.substring(2).replace(phoneReg,phonePattern);
                    }else{
                        phone = '+7 ' + digits.substring(0).replace(phoneReg,phonePattern);
                    }

                    if(phone.length >= 18){
                        $("#phone").val(phone).closest('.form-group').hide().removeClass('hide').show();
                        return;
                    }
                }else{
                    if(skypeReg.test(value)){
                        $("#skype").val(value).closest('.form-group').hide().removeClass('hide').show();
                        return;
                    }
                }
            }
        }
    }).on('blur',function(){
                if(!$("#skype").is(":hidden")){
                    $.get('/?option=main&task=checkSkype&login=' + $("#skype").val(),function(response){
                        if(response.success){
                            if(!response.available){
                                $("#skype").popover({
                                    content:'К сожалению такого логина не существует. Введите верный логин.',
                                    placement: 'top',
                                }).popover('show');

                                $("#skype").addClass('error');

                                setTimeout(function(){
                                    $("#skype").popover('hide');
                                },3000);
                            }else{
                                $("#skype").removeClass('error');
                            }
                        }
                    });
                }
            });


    if($("#contact").val().length && $("#fullname").val().length && $("#fulladdress").val().length){
        $("#contact").keyup();
        $("#fullname").parent().hide();
        $(".fullname-group").hide().removeClass('hide').show(300);
        $("#fulladdress").parent().hide();
        $(".fulladdress-group").hide().removeClass('hide').show(300);
        $("#comment").focus();
    }else{
        $("#contact").focus();
    }

</script>

{{!
<!--Tabs Widget-->
<section class="tabs-widget">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs">
        <li class="active"><a href="#bestsel" data-toggle="tab">Bestseller items</a></li>
        <li><a href="#onsale" data-toggle="tab">Items on sale</a></li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade in active" id="bestsel">
            <div class="container">
                <div class="row">
                    <div class="col-lg-7 col-md-7 col-sm-7">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>X-MAS LIGHT IPHONE LENS<span>$14.95</span></div></div>
                            </div>
                            <img src="img/media/1.jpg" alt="1"/>
                        </a>
                    </div>
                    <div class="col-lg-5 col-md-5 col-sm-5">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Hedadset for iPhone<span>$19.40</span></div></div>
                            </div>
                            <img src="img/media/2.jpg" alt="2"/>
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Product Name<span>$24.15</span></div></div>
                            </div>
                            <img src="img/media/3.jpg" alt="3"/>
                        </a>
                    </div>
                    <div class="col-lg-5 col-md-5 col-sm-5">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Product Name<span>$24.15</span></div></div>
                            </div>
                            <img src="img/media/4.jpg" alt="4"/>
                        </a>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Product Name<span>$24.15</span></div></div>
                            </div>
                            <img src="img/media/5.jpg" alt="5"/>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="onsale">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>X-MAS LIGHT IPHONE LENS<span>$14.95</span></div></div>
                            </div>
                            <img src="img/media/6.jpg" alt="1"/>
                        </a>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Hedadset for iPhone<span>$19.40</span></div></div>
                            </div>
                            <img src="img/media/6.jpg" alt="2"/>
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Product Name<span>$24.15</span></div></div>
                            </div>
                            <img src="img/media/6.jpg" alt="3"/>
                        </a>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <a class="media-link" href="#">
                            <div class="overlay">
                                <div class="descr"><div>Product Name<span>$24.15</span></div></div>
                            </div>
                            <img src="img/media/6.jpg" alt="4"/>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section><!--Tabs Widget Close-->

<!--Brands Carousel Widget-->
<section class="brand-carousel">
    <div class="container">
        <h2>Brands in our shop</h2>
        <div class="inner">
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
            <a class="item" href="#"><img src="img/brands/1.png" alt="1"/></a>
        </div>
    </div>
</section><!--Brands Carousel Close-->
}}